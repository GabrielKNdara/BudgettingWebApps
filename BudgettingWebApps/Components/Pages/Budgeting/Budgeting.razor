@page "/budgeting"
@rendermode InteractiveServer
@using BudgettingWebApps.Models
@using BudgettingWebApps.Components.Pages.Budgeting.Components
@using BudgettingWebApps.Reposiotories
@using System.Security.Claims
@using BudgettingWebApps.Components.Pages.Budgeting.Dialogs

<h3>Budgeting</h3>
<button @onclick="ShowAddIncomeDialog">Add Income</button>

<AddIncomeDialog IsVisible="@isAddIncomeDialogVisible"
                 IsEditMode="@isEditMode"
                 IncomeSource="@incomeSource"
                 Amount="@amount"
                 IncomeId="@incomeId"
                 OnClose="CloseAddIncomeDialog"
                 OnSubmit="HandleIncomeSubmit" />

<table class="table">
    <thead>
        <tr>
            <th>Income Name</th>
            <th>Amount</th>
            <th>Date</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var income in _income)
        {
            <tr>
                <td>@income.IncomeName</td>
                <td>@income.Amount</td>
                <td>@income.TransactionDate.ToShortDateString()</td>
                <td>
                    <button @onclick="() => EditIncome(income)">Edit</button>
                    <button @onclick="() => DeleteIncome(income.Id)">Delete</button>
                </td>
            </tr>
        }
    </tbody>
</table>

@code {
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }

    private IEnumerable<IncomeDto> _income = new List<IncomeDto>();

    [Inject]
    private IincomeRepository repository { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        var authenticationState = await authenticationStateTask;
        var user = authenticationState.User;

        var userIdClaim = user.FindFirst(ClaimTypes.PrimarySid);
        var userId = userIdClaim?.Value;

        var currentuser = Convert.ToInt16(userId);

        _income = await repository.GetIncome(currentuser);
        await base.OnInitializedAsync();
    }

    private bool isAddIncomeDialogVisible = false;
    private bool isEditMode = false;
    private string incomeSource = string.Empty;
    private decimal amount = 0;
    private int? incomeId = null;

    private void ShowAddIncomeDialog()
    {
        isEditMode = false;
        incomeSource = string.Empty;
        amount = 0;
        incomeId = null;
        isAddIncomeDialogVisible = true;
    }

    private void EditIncome(IncomeDto income)
    {
        isEditMode = true;
        incomeSource = income.IncomeName;
        amount = income.Amount;
        incomeId = income.Id;
        isAddIncomeDialogVisible = true;
    }

    private void CloseAddIncomeDialog()
    {
        isAddIncomeDialogVisible = false;
    }

    private async Task HandleIncomeSubmit((string IncomeSource, decimal Amount, int? IncomeId) incomeDetails)
    {
        if (incomeDetails.IncomeId.HasValue)
        {
            // Update existing income
            var incomeToUpdate = _income.FirstOrDefault(i => i.Id == incomeDetails.IncomeId.Value);
            if (incomeToUpdate != null)
            {
                incomeToUpdate.IncomeName = incomeDetails.IncomeSource;
                incomeToUpdate.Amount = incomeDetails.Amount;
                await repository.UpdateIncome(incomeToUpdate); // Assuming UpdateIncome method exists
            }
        }
        else
        {
            // Add new income
            var newIncome = new IncomeDto
                {
                    IncomeName = incomeDetails.IncomeSource,
                    Amount = incomeDetails.Amount,
                    TransactionDate = DateTime.Now, // Assuming Date is automatically set
                    UserId = Convert.ToInt32(authenticationStateTask.Result.User.FindFirst(ClaimTypes.PrimarySid)?.Value)
                };
            await repository.CreateNewIncome(newIncome); // Assuming AddIncome method exists
        }

        // Refresh the income list
        _income = await repository.GetIncome(Convert.ToInt16(authenticationStateTask.Result.User.FindFirst(ClaimTypes.PrimarySid)?.Value));
        CloseAddIncomeDialog();
    }
    private async Task DeleteIncome(int incomeId)
    {
        await repository.DeleteIncome(incomeId); // Assuming DeleteIncome method exists
        _income = await repository.GetIncome(Convert.ToInt16(authenticationStateTask.Result.User.FindFirst(ClaimTypes.PrimarySid)?.Value));
    }
}
