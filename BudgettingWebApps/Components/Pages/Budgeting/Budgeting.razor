@page "/budgeting"
@rendermode InteractiveServer
@using BudgettingWebApps.Models
@using BudgettingWebApps.Components.Pages.Budgeting.Components
@using BudgettingWebApps.Reposiotories
@using System.Security.Claims
@using BudgettingWebApps.Components.Pages.Budgeting.Dialogs


<h3>Budgeting</h3>

<button @onclick="ShowAddIncomeDialog">Add Income</button>

<AddIncomeDialog IsVisible="@isAddIncomeDialogVisible" OnClose="CloseAddIncomeDialog" OnSubmit="HandleIncomeSubmit" />


<table class="table">
    <thead>
        <tr>
            <th>Income Name</th>
            <th>Amount</th>
            <th>Date</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var income in _income)
        {
            <IncomeRows @key="income" Income="@income" />
        }
    </tbody>
</table>

@code {
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }

    IEnumerable<IncomeDto> _income = new List<IncomeDto>();

    IncomeDto income = new IncomeDto();


    [Inject]
    private IincomeRepository repository { get; set; } = default!;
    int currentUser;

    protected override async Task OnInitializedAsync()
    {
        var authenticationState = await authenticationStateTask;
        var user = authenticationState.User;

        var userIdClaim = user.FindFirst(ClaimTypes.PrimarySid);
        var userId = userIdClaim?.Value;

        currentUser = Convert.ToInt16(userId);

        //_income = await repository.GetIncome(currentUser);
        await Load();
        await base.OnInitializedAsync();
    }
    private async Task Load()
    {
        _income = await repository.GetIncome(currentUser);
    }

    private bool isAddIncomeDialogVisible = false;

    private void ShowAddIncomeDialog()
    {
        isAddIncomeDialogVisible = true;
    }

    private void CloseAddIncomeDialog()
    {
        isAddIncomeDialogVisible = false;
    }

    private async Task HandleIncomeSubmit((string IncomeSource, decimal Amount) incomeDetails)
    {
        // Handle the submitted income details (e.g., add to a list, save to database)
        income.UserId = currentUser;
        income.IncomeName = incomeDetails.IncomeSource;
        income.Amount = incomeDetails.Amount;
        income.TransactionDate = DateTime.Now;
        await repository.CreateNewIncome(income);
        Console.WriteLine($"Income Source: {incomeDetails.IncomeSource}, Amount: {incomeDetails.Amount}");
        CloseAddIncomeDialog();
        await Load();
    }
}
